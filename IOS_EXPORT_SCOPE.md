# iOS Export Artifacts Scope (Follow Android Logic)

## Goal
Add iOS artifact export that mirrors the Android export flow:
copy artifacts into a dedicated artifacts folder, export paths via Envman, and
produce a zip containing test artifacts. iOS export must fail on missing files
or invalid build flags.

## Inputs and Build Flags
- Platform is read from the existing `PLATFORM` env (same as Android).
- Build type is `debug` or `release`.
- iOS build rules:
  - `debug` must be combined with `--simulator` (device debug is not supported).
  - `release` must run without `--simulator`.

## Source Paths
Root: `build/ios_integ/Build/Products`

Build directory selection:
- `release` -> `Release-iphoneos`
- `debug` + simulator -> `Debug-iphonesimulator`
- `debug` without simulator -> error (hard fail)
- `release` + simulator -> error (hard fail)

Expected artifacts inside the build directory:
- `Runner.app` (app under test)
- `RunnerUITests-Runner.app` (test instrumentation app)

Expected xctestrun file:
- `*.xctestrun` located in `build/ios_integ/Build/Products`

## Outputs (step.yml)
Add the following outputs in `step.yml` with metadata:

- `IOS_APP_UNDER_TEST`
  - title: iOS App Under Test Path
  - summary: This output contains the path to the iOS app under test
  - description: The path to the iOS Runner.app generated by the step

- `IOS_TEST_INSTRUMENTATION_APP`
  - title: iOS Test Instrumentation App Path
  - summary: This output contains the path to the iOS test instrumentation app
  - description: The path to the RunnerUITests-Runner.app generated by the step

- `IOS_RUNNER_FILE`
  - title: iOS xctestrun File Path
  - summary: This output contains the path to the iOS xctestrun file
  - description: The path to the .xctestrun file generated by the step

- `IOS_BUILD_EXPORTS`
  - title: iOS Build Exports Zip Path
  - summary: This output contains the path to the zip with iOS test artifacts
  - description: The path to the zip containing the build directory and the .xctestrun file

## Export Behavior
- Create an iOS artifacts folder (similar to Android) and copy:
  - `Runner.app`
  - `RunnerUITests-Runner.app`
  - `*.xctestrun`
- Export each path via Envman using the EnvExporter interface.
- Create a zip that includes the build directory and the `.xctestrun` file.

Zip command (run from `build/ios_integ/Build/Products`):
```
zip -r ios_tests.zip <BuildDir> *.xctestrun
```
Where `<BuildDir>` is `Release-iphoneos` or `Debug-iphonesimulator`.

## Failure Behavior (Hard Fail)
- Missing any of: `Runner.app`, `RunnerUITests-Runner.app`, or `.xctestrun` -> error.
- Invalid combination: `debug` without simulator, or `release + simulator` -> error.
- Envman export error (including missing envman) -> error.
- Zip creation failure -> error.

## Implementation Plan
1) Add iOS constants in `steps/export_artifacts/constants/export_artifacts_constants.go`:
   - iOS artifacts path (e.g., `patrol/ios`)
   - iOS env keys listed above.
2) Implement iOS export logic in `steps/export_artifacts/export_ios_artifacts`:
   - Resolve build directory based on build type and simulator flag.
   - Find `Runner.app` and `RunnerUITests-Runner.app` in build directory.
   - Find first `.xctestrun` in `build/ios_integ/Build/Products`.
   - Create artifacts folder; copy files; export env vars via EnvExporter.
   - Build zip and export its path via EnvExporter.
3) Extend `steps/export_artifacts/exporter.go` and `steps/export_artifacts/exporter_runner.go`:
   - Add `FindAndExportIOS() error`.
   - Call iOS export when platform is `ios` or `both`.
4) Update `step.yml` outputs to include iOS keys/metadata above.
5) Add tests (follow Android patterns, using the EnvExporter stub):
   - Success: release device (Release-iphoneos).
   - Success: debug simulator (Debug-iphonesimulator).
   - Failure: missing file(s).
   - Failure: debug without simulator.
   - Failure: release + simulator.
   - Zip creation and export path validation (verify zip exists; optionally inspect contents with `archive/zip`).

## Edge Cases
- Multiple `.xctestrun` files: pick the first one deterministically (document selection).
- If multiple `.app` matches exist, use exact filenames `Runner.app` and `RunnerUITests-Runner.app`.
- Ensure no env exports happen after the first error (fail fast).
